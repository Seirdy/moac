image: alpine/edge
packages:
  - clang
  - compiler-rt
  - go
  - lld
  - make
  - musl-dev
  - tar
sources:
  - https://git.sr.ht/~seirdy/moac
tasks:
  - setup_env: |
      sudo sh moac/.builds/setup-alpine.sh
      go version
  - build: |
      cd moac
      make build
      make BIN=moac-cgo RELEASE_SANITIZERS=cfi build-cgo-static
      tar czf ~/moac-linux-amd64-musl-static-pie.tar.gz ./moac ./moac-cgo
  - test: |
      cd moac
      make test-race

artifacts:
  - moac-linux-amd64-musl-static-pie.tar.gz
