image: alpine/edge
packages:
  - clang
  - compiler-rt
  - go
  - lld
  # we use gmake in fedora and openbsd make in openbsd, so freebsd make is the last major make impl. to test.
  - bmake
  - musl-dev
sources:
  - https://git.sr.ht/~seirdy/moac
tasks:
  - setup_env: |
      sudo sh moac/.builds/setup-alpine.sh
      go version
  - build: |
      cd moac
      bmake build
      # alpine doesn't support safe-stack
      bmake BIN=moac-cgo-static build-cgo-static
      tar czf ~/moac-linux-amd64-musl-static-pie.tar.gz ./moac ./moac-cgo-static
  - test: |
      cd moac
      make test-race

artifacts:
  - moac-linux-amd64-musl-static-pie.tar.gz
